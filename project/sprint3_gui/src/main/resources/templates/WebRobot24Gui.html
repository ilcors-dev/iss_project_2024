<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Waste Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
        }

        .status-badge {
            @apply px-2.5 py-1 rounded-full text-xs font-medium transition-colors duration-200;
        }

        .status-card {
            @apply bg-white rounded-xl shadow-sm border border-gray-100 p-5 transition-all duration-300 hover:shadow-md;
        }

        .animate-pulse-slow {
            animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-800 min-h-screen flex flex-col">
    <div class="flex-1 flex flex-col">
        <!-- Header -->
        <header class="bg-white border-b border-gray-200 sticky top-0 z-10">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-4">
                    <div class="flex items-center space-x-3">
                        <i class="fas fa-recycle text-emerald-500 text-2xl"></i>
                        <h1 class="text-xl font-bold text-gray-900">Waste Management System</h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span id="connection-status"
                            class="status-badge bg-gray-100 text-gray-700 flex items-center gap-1.5">
                            <span class="h-2 w-2 rounded-full bg-gray-400"></span>
                            Initializing...
                        </span>
                        <div class="flex gap-2">
                            <button onclick="connect()"
                                class="bg-emerald-50 hover:bg-emerald-100 text-emerald-700 px-3 py-1.5 rounded-md text-sm font-medium transition-colors flex items-center gap-1.5">
                                <i class="fas fa-plug text-xs"></i>
                                Connect
                            </button>
                            <button onclick="disconnect()"
                                class="bg-red-50 hover:bg-red-100 text-red-700 px-3 py-1.5 rounded-md text-sm font-medium transition-colors flex items-center gap-1.5">
                                <i class="fas fa-power-off text-xs"></i>
                                Disconnect
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 py-8">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <!-- Dashboard Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <!-- Waste Storage Card -->
                    <div class="status-card">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-sm font-medium text-gray-500">Waste Storage</h3>
                            <i class="fas fa-trash-alt text-blue-500"></i>
                        </div>
                        <div class="flex items-end justify-between">
                            <div>
                                <div id="waste-storage" class="text-2xl font-bold">--</div>
                                <div class="text-xs text-gray-500 mt-1">Roll Packets</div>
                            </div>
                            <div id="waste-storage-indicator"
                                class="h-10 w-10 rounded-full flex items-center justify-center bg-blue-50 text-blue-500">
                                <i class="fas fa-box"></i>
                            </div>
                        </div>
                        <div class="mt-4 pt-3 border-t border-gray-100">
                            <div class="text-xs text-gray-500">Storage capacity</div>
                            <div class="mt-1 h-2 w-full bg-gray-100 rounded-full overflow-hidden">
                                <div id="waste-storage-bar" class="h-full bg-blue-500 rounded-full" style="width: 0%">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Ash Storage Card -->
                    <div class="status-card">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-sm font-medium text-gray-500">Ash Storage</h3>
                            <i class="fas fa-fire-alt text-amber-500"></i>
                        </div>
                        <div class="flex items-end justify-between">
                            <div>
                                <div id="ash-storage" class="text-2xl font-bold">--</div>
                                <div class="text-xs text-gray-500 mt-1">Occupancy Level</div>
                            </div>
                            <div id="ash-storage-indicator"
                                class="h-10 w-10 rounded-full flex items-center justify-center bg-amber-50 text-amber-500">
                                <i class="fas fa-burn"></i>
                            </div>
                        </div>
                        <div class="mt-4 pt-3 border-t border-gray-100">
                            <div class="text-xs text-gray-500">Storage capacity</div>
                            <div class="mt-1 h-2 w-full bg-gray-100 rounded-full overflow-hidden">
                                <div id="ash-storage-bar" class="h-full bg-amber-500 rounded-full" style="width: 0%">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Incinerator Status Card -->
                    <div class="status-card">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-sm font-medium text-gray-500">Incinerator</h3>
                            <i class="fas fa-temperature-high text-red-500"></i>
                        </div>
                        <div class="flex items-end justify-between">
                            <div>
                                <div id="incinerator-status" class="text-2xl font-bold">--</div>
                                <div class="text-xs text-gray-500 mt-1">Current Status</div>
                            </div>
                            <div id="incinerator-indicator"
                                class="h-10 w-10 rounded-full flex items-center justify-center bg-red-50 text-red-500">
                                <i class="fas fa-fire"></i>
                            </div>
                        </div>
                        <div class="mt-4 pt-3 border-t border-gray-100">
                            <div class="text-xs text-gray-500">Last activity</div>
                            <div id="incinerator-last-active" class="text-xs text-gray-700 mt-1">--</div>
                        </div>
                    </div>

                    <!-- Robot Location Card -->
                    <div class="status-card">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-sm font-medium text-gray-500">OpRobot</h3>
                            <i class="fas fa-robot text-indigo-500"></i>
                        </div>
                        <div class="flex items-end justify-between">
                            <div>
                                <div id="robot-location" class="text-2xl font-bold">--</div>
                                <div class="text-xs text-gray-500 mt-1">Current Location</div>
                            </div>
                            <div id="robot-indicator"
                                class="h-10 w-10 rounded-full flex items-center justify-center bg-indigo-50 text-indigo-500">
                                <i class="fas fa-map-marker-alt"></i>
                            </div>
                        </div>
                        <div class="mt-4 pt-3 border-t border-gray-100">
                            <div class="text-xs text-gray-500">Movement status</div>
                            <div class="mt-1 flex items-center">
                                <span id="robot-status-badge" class="status-badge bg-gray-100 text-gray-700">
                                    Unknown
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- MQTT Messages and System Log -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <!-- MQTT Messages -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-100">
                        <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center">
                            <div>
                                <h2 class="text-lg font-semibold text-gray-800">MQTT Messages</h2>
                                <p class="text-xs text-gray-500 mt-1">Topic: it.unib0.iss.waste-incinerator-service</p>
                            </div>
                            <div class="flex items-center gap-2">
                                <span id="mqtt-status"
                                    class="status-badge bg-gray-100 text-gray-700 flex items-center gap-1.5">
                                    <span class="h-2 w-2 rounded-full bg-gray-400"></span>
                                    Disconnected
                                </span>
                                <button id="connect-mqtt"
                                    class="text-xs bg-emerald-50 hover:bg-emerald-100 text-emerald-700 px-2 py-1 rounded">
                                    Connect
                                </button>
                            </div>
                        </div>
                        <div id="mqtt-messages" class="p-4 h-[300px] overflow-y-auto text-sm font-mono">
                            <div class="text-gray-500 text-xs">Waiting for MQTT messages...</div>
                        </div>
                    </div>

                    <!-- System Log -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-100">
                        <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center">
                            <h2 class="text-lg font-semibold text-gray-800">System Log</h2>
                            <button id="clear-log"
                                class="text-xs bg-gray-50 hover:bg-gray-100 text-gray-700 px-2 py-1 rounded">
                                Clear
                            </button>
                        </div>
                        <div id="system-log" class="p-4 h-[300px] overflow-y-auto text-sm font-mono">
                            <div class="text-gray-500 text-xs">Waiting for system events...</div>
                        </div>
                    </div>
                </div>

                <!-- System Overview -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 mb-8">
                    <div class="px-6 py-5 border-b border-gray-100">
                        <h2 class="text-lg font-semibold text-gray-800">System Overview</h2>
                        <p class="text-sm text-gray-500 mt-1">Real-time visualization of the waste management process
                        </p>
                    </div>
                    <div class="p-6">
                        <div class="flex flex-col lg:flex-row gap-8">
                            <!-- System Diagram -->
                            <div
                                class="flex-1 min-h-[300px] bg-gray-50 rounded-lg p-4 flex items-center justify-center">
                                <div class="text-center">
                                    <div class="grid grid-cols-3 gap-4">
                                        <div id="storage-zone"
                                            class="border-2 border-blue-200 rounded-lg p-4 flex flex-col items-center justify-center h-32 bg-blue-50 transition-colors duration-300">
                                            <i class="fas fa-warehouse text-blue-500 text-xl mb-2"></i>
                                            <span class="text-sm font-medium">Storage</span>
                                            <span id="storage-count" class="text-xs mt-1 text-blue-600">-- RPs</span>
                                        </div>

                                        <div id="robot-zone"
                                            class="border-2 border-indigo-200 rounded-lg p-4 flex flex-col items-center justify-center h-32 bg-indigo-50 transition-colors duration-300">
                                            <i class="fas fa-robot text-indigo-500 text-xl mb-2"></i>
                                            <span class="text-sm font-medium">Robot</span>
                                            <span id="robot-position" class="text-xs mt-1 text-indigo-600">--</span>
                                        </div>

                                        <div id="incinerator-zone"
                                            class="border-2 border-red-200 rounded-lg p-4 flex flex-col items-center justify-center h-32 bg-red-50 transition-colors duration-300">
                                            <i class="fas fa-fire text-red-500 text-xl mb-2"></i>
                                            <span class="text-sm font-medium">Incinerator</span>
                                            <span id="incinerator-state" class="text-xs mt-1 text-red-600">--</span>
                                        </div>
                                    </div>

                                    <div
                                        class="mt-4 border-2 border-amber-200 rounded-lg p-4 flex flex-col items-center justify-center h-24 bg-amber-50 transition-colors duration-300">
                                        <i class="fas fa-burn text-amber-500 text-xl mb-2"></i>
                                        <span class="text-sm font-medium">Ash Storage</span>
                                        <span id="ash-level" class="text-xs mt-1 text-amber-600">-- %</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Chart Container -->
                            <div class="flex-1">
                                <canvas id="distance-chart" height="300"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="bg-white border-t border-gray-200 py-4">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex flex-col md:flex-row justify-between items-center">
                    <p class="text-sm text-gray-500">
                        &copy; 2024 Waste Management System. All rights reserved.
                    </p>
                    <div class="flex items-center space-x-2 mt-2 md:mt-0">
                        <span class="text-xs text-gray-400">Last updated:</span>
                        <span id="last-updated" class="text-xs text-gray-600">Never</span>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <script>
        var socket;
        var mqttClient;
        var connectionStatus = document.getElementById('connection-status');
        var mqttStatus = document.getElementById('mqtt-status');
        var systemLog = document.getElementById('system-log');
        var mqttMessages = document.getElementById('mqtt-messages');
        var lastUpdated = document.getElementById('last-updated');
        var wasteStorageData = [];
        var ashStorageData = [];
        var chart;

        // Initialize chart
        function initChart() {
            const ctx = document.getElementById('distance-chart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [
                        {
                            label: 'Waste Storage',
                            data: wasteStorageData,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.3,
                            fill: true
                        },
                        {
                            label: 'Ash Storage',
                            data: ashStorageData,
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            tension: 0.3,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            usePointStyle: true
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'minute',
                                tooltipFormat: 'HH:mm:ss'
                            },
                            title: {
                                display: true,
                                text: 'Time'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Value'
                            }
                        }
                    }
                }
            });
        }

        // Add log entry
        function addLogEntry(message, type = 'info') {
            const entry = document.createElement('div');
            const timestamp = new Date().toLocaleTimeString();

            entry.className = 'mb-1 pb-1 border-b border-gray-100';

            let iconClass = 'fas fa-info-circle text-blue-500';
            if (type === 'warning') iconClass = 'fas fa-exclamation-triangle text-amber-500';
            if (type === 'error') iconClass = 'fas fa-times-circle text-red-500';
            if (type === 'success') iconClass = 'fas fa-check-circle text-green-500';

            entry.innerHTML = `
        <span class="text-gray-400 text-xs">${timestamp}</span>
        <div class="flex items-start mt-1">
          <i class="${iconClass} mr-2 mt-0.5"></i>
          <span class="text-xs">${message}</span>
        </div>
      `;

            systemLog.appendChild(entry);
            systemLog.scrollTop = systemLog.scrollHeight;
        }

        // Add MQTT message
        function addMqttMessage(message) {
            const entry = document.createElement('div');
            const timestamp = new Date().toLocaleTimeString();

            entry.className = 'mb-2 pb-2 border-b border-gray-100';

            entry.innerHTML = `
        <span class="text-gray-400 text-xs">${timestamp}</span>
        <div class="mt-1 p-2 bg-gray-50 rounded text-xs overflow-x-auto">
          ${message}
        </div>
      `;

            mqttMessages.appendChild(entry);
            mqttMessages.scrollTop = mqttMessages.scrollHeight;
        }

        // Update connection status
        function updateConnectionStatus(status) {
            const statusDot = connectionStatus.querySelector('span');

            switch (status) {
                case 'Connected':
                    connectionStatus.className = 'status-badge bg-green-100 text-green-800 flex items-center gap-1.5';
                    statusDot.className = 'h-2 w-2 rounded-full bg-green-500 animate-pulse-slow';
                    connectionStatus.innerHTML = `<span class="h-2 w-2 rounded-full bg-green-500 animate-pulse-slow"></span> Connected`;
                    addLogEntry('WebSocket connection established', 'success');
                    break;
                case 'Connecting...':
                    connectionStatus.className = 'status-badge bg-amber-100 text-amber-800 flex items-center gap-1.5';
                    statusDot.className = 'h-2 w-2 rounded-full bg-amber-500 animate-pulse-slow';
                    connectionStatus.innerHTML = `<span class="h-2 w-2 rounded-full bg-amber-500 animate-pulse-slow"></span> Connecting...`;
                    addLogEntry('Attempting to establish WebSocket connection...', 'info');
                    break;
                case 'Disconnected':
                    connectionStatus.className = 'status-badge bg-red-100 text-red-800 flex items-center gap-1.5';
                    statusDot.className = 'h-2 w-2 rounded-full bg-red-500';
                    connectionStatus.innerHTML = `<span class="h-2 w-2 rounded-full bg-red-500"></span> Disconnected`;
                    addLogEntry('WebSocket connection closed', 'warning');
                    break;
                default:
                    connectionStatus.className = 'status-badge bg-gray-100 text-gray-700 flex items-center gap-1.5';
                    statusDot.className = 'h-2 w-2 rounded-full bg-gray-400';
                    connectionStatus.innerHTML = `<span class="h-2 w-2 rounded-full bg-gray-400"></span> ${status}`;
            }
        }

        // Update MQTT connection status
        function updateMqttStatus(status) {
            const statusDot = mqttStatus.querySelector('span');

            switch (status) {
                case 'Connected':
                    mqttStatus.className = 'status-badge bg-green-100 text-green-800 flex items-center gap-1.5';
                    statusDot.className = 'h-2 w-2 rounded-full bg-green-500 animate-pulse-slow';
                    mqttStatus.innerHTML = `<span class="h-2 w-2 rounded-full bg-green-500 animate-pulse-slow"></span> Connected`;
                    addLogEntry('MQTT connection established', 'success');
                    break;
                case 'Connecting...':
                    mqttStatus.className = 'status-badge bg-amber-100 text-amber-800 flex items-center gap-1.5';
                    statusDot.className = 'h-2 w-2 rounded-full bg-amber-500 animate-pulse-slow';
                    mqttStatus.innerHTML = `<span class="h-2 w-2 rounded-full bg-amber-500 animate-pulse-slow"></span> Connecting...`;
                    addLogEntry('Attempting to establish MQTT connection...', 'info');
                    break;
                case 'Disconnected':
                    mqttStatus.className = 'status-badge bg-red-100 text-red-800 flex items-center gap-1.5';
                    statusDot.className = 'h-2 w-2 rounded-full bg-red-500';
                    mqttStatus.innerHTML = `<span class="h-2 w-2 rounded-full bg-red-500"></span> Disconnected`;
                    addLogEntry('MQTT connection closed', 'warning');
                    break;
                default:
                    mqttStatus.className = 'status-badge bg-gray-100 text-gray-700 flex items-center gap-1.5';
                    statusDot.className = 'h-2 w-2 rounded-full bg-gray-400';
                    mqttStatus.innerHTML = `<span class="h-2 w-2 rounded-full bg-gray-400"></span> ${status}`;
            }
        }

        // Update waste storage display
        function updateWasteStorage(value) {
            const wasteStorage = document.getElementById('waste-storage');
            const wasteStorageBar = document.getElementById('waste-storage-bar');
            const wasteStorageIndicator = document.getElementById('waste-storage-indicator');
            const storageCount = document.getElementById('storage-count');
            const storageZone = document.getElementById('storage-zone');

            wasteStorage.textContent = value;
            storageCount.textContent = `${value} RPs`;

            // Assuming max capacity is 5 for visualization
            const percentage = Math.min((value / 5) * 100, 100);
            wasteStorageBar.style.width = `${percentage}%`;

            // Update indicator color based on capacity
            if (percentage > 80) {
                wasteStorageIndicator.className = 'h-10 w-10 rounded-full flex items-center justify-center bg-red-50 text-red-500';
                storageZone.className = 'border-2 border-red-200 rounded-lg p-4 flex flex-col items-center justify-center h-32 bg-red-50 transition-colors duration-300';
            } else if (percentage > 50) {
                wasteStorageIndicator.className = 'h-10 w-10 rounded-full flex items-center justify-center bg-amber-50 text-amber-500';
                storageZone.className = 'border-2 border-amber-200 rounded-lg p-4 flex flex-col items-center justify-center h-32 bg-amber-50 transition-colors duration-300';
            } else {
                wasteStorageIndicator.className = 'h-10 w-10 rounded-full flex items-center justify-center bg-blue-50 text-blue-500';
                storageZone.className = 'border-2 border-blue-200 rounded-lg p-4 flex flex-col items-center justify-center h-32 bg-blue-50 transition-colors duration-300';
            }

            // Add data point to chart
            wasteStorageData.push({
                x: new Date(),
                y: parseInt(value)
            });

            // Keep only last 20 data points
            if (wasteStorageData.length > 20) {
                wasteStorageData.shift();
            }

            if (chart) {
                chart.update();
            }
        }

        // Update ash storage display
        function updateAshStorage(value) {
            const ashStorage = document.getElementById('ash-storage');
            const ashStorageBar = document.getElementById('ash-storage-bar');
            const ashStorageIndicator = document.getElementById('ash-storage-indicator');
            const ashLevel = document.getElementById('ash-level');

            ashStorage.textContent = value;
            ashLevel.textContent = value;

            // Assuming value is already a percentage
            ashStorageBar.style.width = value;

            // Update indicator color based on capacity
            if (value > 80) {
                ashStorageIndicator.className = 'h-10 w-10 rounded-full flex items-center justify-center bg-red-50 text-red-500';
                addLogEntry(`Ash storage at critical level: ${value}`, 'warning');
            } else if (value > 50) {
                ashStorageIndicator.className = 'h-10 w-10 rounded-full flex items-center justify-center bg-amber-50 text-amber-500';
            } else {
                ashStorageIndicator.className = 'h-10 w-10 rounded-full flex items-center justify-center bg-amber-50 text-amber-500';
            }

            // Add data point to chart
            ashStorageData.push({
                x: new Date(),
                y: parseInt(value)
            });

            // Keep only last 20 data points
            if (ashStorageData.length > 20) {
                ashStorageData.shift();
            }

            if (chart) {
                chart.update();
            }
        }

        // Update incinerator status display
        function updateIncineratorStatus(value) {
            const incineratorStatus = document.getElementById('incinerator-status');
            const incineratorIndicator = document.getElementById('incinerator-indicator');
            const incineratorLastActive = document.getElementById('incinerator-last-active');
            const incineratorState = document.getElementById('incinerator-state');
            const incineratorZone = document.getElementById('incinerator-zone');

            incineratorStatus.textContent = value;
            incineratorState.textContent = value;

            if (value === '1' || value.toLowerCase() === 'on') {
                incineratorStatus.textContent = 'Active';
                incineratorState.textContent = 'Active';
                incineratorLastActive.textContent = new Date().toLocaleTimeString();
                incineratorIndicator.className = 'h-10 w-10 rounded-full flex items-center justify-center bg-green-50 text-green-500';
                incineratorZone.className = 'border-2 border-green-200 rounded-lg p-4 flex flex-col items-center justify-center h-32 bg-green-50 transition-colors duration-300';
                addLogEntry('Incinerator is now active', 'info');
            } else {
                incineratorStatus.textContent = 'Inactive';
                incineratorState.textContent = 'Inactive';
                incineratorIndicator.className = 'h-10 w-10 rounded-full flex items-center justify-center bg-gray-50 text-gray-500';
                incineratorZone.className = 'border-2 border-gray-200 rounded-lg p-4 flex flex-col items-center justify-center h-32 bg-gray-50 transition-colors duration-300';
            }
        }

        // Update robot location display
        function updateRobotLocation(value) {
            const robotLocation = document.getElementById('robot-location');
            const robotIndicator = document.getElementById('robot-indicator');
            const robotStatusBadge = document.getElementById('robot-status-badge');
            const robotPosition = document.getElementById('robot-position');
            const robotZone = document.getElementById('robot-zone');

            robotLocation.textContent = value;
            robotPosition.textContent = value;

            if (value.toLowerCase() === 'home') {
                robotStatusBadge.className = 'status-badge bg-green-100 text-green-800';
                robotStatusBadge.textContent = 'At Home Base';
                robotIndicator.className = 'h-10 w-10 rounded-full flex items-center justify-center bg-green-50 text-green-500';
            } else if (value.toLowerCase() === 'storage') {
                robotStatusBadge.className = 'status-badge bg-blue-100 text-blue-800';
                robotStatusBadge.textContent = 'At Storage';
                robotIndicator.className = 'h-10 w-10 rounded-full flex items-center justify-center bg-blue-50 text-blue-500';
                robotZone.className = 'border-2 border-blue-200 rounded-lg p-4 flex flex-col items-center justify-center h-32 bg-blue-50 transition-colors duration-300';
                addLogEntry('Robot arrived at storage area', 'info');
            } else if (value.toLowerCase() === 'incinerator') {
                robotStatusBadge.className = 'status-badge bg-red-100 text-red-800';
                robotStatusBadge.textContent = 'At Incinerator';
                robotIndicator.className = 'h-10 w-10 rounded-full flex items-center justify-center bg-red-50 text-red-500';
                robotZone.className = 'border-2 border-red-200 rounded-lg p-4 flex flex-col items-center justify-center h-32 bg-red-50 transition-colors duration-300';
                addLogEntry('Robot arrived at incinerator', 'info');
            } else {
                robotStatusBadge.className = 'status-badge bg-indigo-100 text-indigo-800';
                robotStatusBadge.textContent = 'Moving';
                robotIndicator.className = 'h-10 w-10 rounded-full flex items-center justify-center bg-indigo-50 text-indigo-500 animate-pulse-slow';
                robotZone.className = 'border-2 border-indigo-200 rounded-lg p-4 flex flex-col items-center justify-center h-32 bg-indigo-50 transition-colors duration-300';
            }
        }

        // Connect to WebSocket
        function connect() {
            updateConnectionStatus('Connecting...');

            // Get host and set WebSocket path
            var host = document.location.host;
            var pathname = '/';
            var addr = 'ws://' + host + pathname + 'WebRobot24Gui';

            // Close existing WebSocket connection if present
            if (socket != null) {
                socket.close();
            }

            // Initialize new WebSocket connection
            socket = new WebSocket(addr);

            socket.onopen = function () {
                console.log('Connected to WebSocket');
                updateConnectionStatus('Connected');
            };

            socket.onmessage = function (event) {
                // Extract message content from WebSocket
                const data = event.data;
                console.log(data);

                let splitted = data.replace(/'/g, "").split(";");
                console.log(splitted);

                const app = splitted[0].split("=")[1].trim();
                const wasteStorageMatch = splitted[1].split("=")[1].trim();
                const incineratorStatusMatch = splitted[2].split("=")[1].trim();
                const robotLocationMatch = splitted[3].split("=")[1].trim();
                const ashStorageMatch = splitted[4].split("=")[1].trim();

                // Update table fields with extracted data
                if (wasteStorageMatch) {
                    updateWasteStorage(wasteStorageMatch);
                }
                if (incineratorStatusMatch) {
                    updateIncineratorStatus(incineratorStatusMatch);
                }
                if (robotLocationMatch) {
                    updateRobotLocation(robotLocationMatch);
                }
                if (ashStorageMatch) {
                    updateAshStorage(ashStorageMatch);
                }

                // Update last updated timestamp
                lastUpdated.textContent = new Date().toLocaleTimeString();
            };

            socket.onerror = function (error) {
                console.error('WebSocket Error:', error);
                updateConnectionStatus('Disconnected');
                addLogEntry('WebSocket connection error', 'error');
            };

            socket.onclose = function () {
                console.log('WebSocket connection closed');
                updateConnectionStatus('Disconnected');
            };
        }

        // Disconnect from WebSocket
        function disconnect() {
            if (socket) {
                socket.close();
                updateConnectionStatus('Disconnected');
            }
        }

        // Connect to MQTT
        function connectMqtt() {
            updateMqttStatus("Connecting...");

            try {
                // Generate a random client ID
                const clientId = "waste_management_" + Math.random().toString(16).substr(2, 8);

                // Use local broker
                const host = "localhost";
                const port = 9001; // WebSocket port

                // Create a new MQTT client instance
                mqttClient = new Paho.MQTT.Client(host, port, clientId);

                // Set callback handlers
                mqttClient.onConnectionLost = onMqttConnectionLost;
                mqttClient.onMessageArrived = onMqttMessageArrived;

                // Connect the client WITHOUT SSL
                mqttClient.connect({
                    onSuccess: onMqttConnect,
                    onFailure: onMqttFailure,
                    useSSL: false,
                    timeout: 3,
                    keepAliveInterval: 30,
                });

                addLogEntry("Connecting to MQTT broker at " + host, "info");
            } catch (error) {
                console.error("MQTT Connection Error:", error);
                updateMqttStatus("Error");
                addLogEntry("MQTT connection error: " + error.message, "error");
            }
        }

        // MQTT connection successful
        function onMqttConnect() {
            console.log("MQTT Connected");
            updateMqttStatus('Connected');

            // Subscribe to the topic
            mqttClient.subscribe("it.unib0.iss.waste-incinerator-service");
            addLogEntry('Subscribed to MQTT topic: it.unib0.iss.waste-incinerator-service', 'success');

            // Send a test message to verify connection
            sendTestMessage();
        }

        // Send a test message to verify MQTT connection
        function sendTestMessage() {
            try {
                const message = new Paho.MQTT.Message("UI connected at " + new Date().toLocaleTimeString());
                message.destinationName = "it.unib0.iss.waste-incinerator-service";
                mqttClient.send(message);
                addLogEntry('Sent test message to MQTT broker', 'info');
            } catch (error) {
                console.error("Error sending test message:", error);
                addLogEntry('Error sending test message: ' + error.message, 'error');
            }
        }

        // MQTT connection failed
        function onMqttFailure(error) {
            console.error("MQTT Connection Failed:", error.errorMessage);
            updateMqttStatus('Disconnected');
            addLogEntry('MQTT connection failed: ' + error.errorMessage, 'error');

            // Try alternative connection method
            tryAlternativeMqttConnection();
        }

        // Try alternative MQTT connection
        function tryAlternativeMqttConnection() {
            addLogEntry('Trying alternative MQTT connection...', 'info');

            // Generate a random client ID
            const clientId = 'waste_management_' + Math.random().toString(16).substr(2, 8);

            // Use HiveMQ public broker with WebSocket (not secure)
            const host = "broker.hivemq.com";
            const port = 8000; // Standard WebSocket port for HiveMQ

            // Create a new MQTT client instance
            mqttClient = new Paho.MQTT.Client(host, port, clientId);

            // Set callback handlers
            mqttClient.onConnectionLost = onMqttConnectionLost;
            mqttClient.onMessageArrived = onMqttMessageArrived;

            // Connect the client without SSL
            mqttClient.connect({
                onSuccess: onMqttConnect,
                onFailure: function (error) {
                    console.error("Alternative MQTT Connection Failed:", error.errorMessage);
                    updateMqttStatus('Failed');
                    addLogEntry('Alternative MQTT connection failed: ' + error.errorMessage, 'error');
                },
                useSSL: false,
                timeout: 3,
                keepAliveInterval: 30
            });
        }

        // MQTT connection lost
        function onMqttConnectionLost(responseObject) {
            if (responseObject.errorCode !== 0) {
                console.log("MQTT Connection Lost:", responseObject.errorMessage);
                updateMqttStatus('Disconnected');
                addLogEntry('MQTT connection lost: ' + responseObject.errorMessage, 'warning');
            }
        }

        // MQTT message received
        function onMqttMessageArrived(message) {
            console.log("MQTT Message Arrived:", message.payloadString);
            addMqttMessage(message.payloadString);
        }

        // Clear log
        document.getElementById('clear-log').addEventListener('click', function () {
            systemLog.innerHTML = '<div class="text-gray-500 text-xs">Log cleared</div>';
        });

        // Connect to MQTT
        document.getElementById('connect-mqtt').addEventListener('click', function () {
            connectMqtt();
        });

        // Initialize chart and connect on page load
        document.addEventListener('DOMContentLoaded', function () {
            initChart();
            connect();

            // Add initial log entry
            addLogEntry('System initialized', 'info');
        });
    </script>
</body>

</html>
